<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <link rel="icon" href="/favicon.ico"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#000000"/>
  <meta name="description" content="Rapport de surveillance des particules en suspension - G-ON Life"/>
  <link rel="apple-touch-icon" href="/logo192.png"/>
  <link rel="manifest" href="/manifest.json"/>
  <title>Rapport de surveillance des particules - G-ON Life</title>
  
  <!-- Styles et scripts externes -->
  <link href="/reports/fourchambault/avril-2025/static/css/main.75db7d16.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  
  <!-- Script d'authentification -->
  <script>
    (function() {
      var isAuthenticated = localStorage.getItem("isAuthenticated");
      var authExpiry = localStorage.getItem("authExpiry");
      var currentReport = localStorage.getItem("currentReport");
      
      // Vérifier si le cookie d'auth est présent
      var hasAuthCookie = document.cookie.indexOf('gon_auth_verified=true') !== -1 ||
                          document.cookie.indexOf('gon_auth_token=') !== -1;
      
      // Si pas authentifié localement ou cookie absent, rediriger
      if (!isAuthenticated || !hasAuthCookie) {
        localStorage.removeItem("isAuthenticated");
        localStorage.removeItem("currentReport");
        localStorage.removeItem("authExpiry");
        window.location.replace("https://monitoring-g-on.life/");
        return;
      }
      
      // Vérifier si l'authentification a expiré
      if (authExpiry) {
        var expiryDate = new Date(authExpiry);
        if (new Date() > expiryDate) {
          // Authentification expirée
          localStorage.removeItem("isAuthenticated");
          localStorage.removeItem("currentReport");
          localStorage.removeItem("authExpiry");
          document.cookie = "gon_auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          document.cookie = "gon_auth_verified=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          window.location.replace("https://monitoring-g-on.life/");
          return;
        }
      }
      
      // Vérification supplémentaire côté serveur
      fetch('/.netlify/functions/auth-middleware', {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + getCookie('gon_auth_token')
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Authentification échouée');
        }
        return response.json();
      })
      .then(data => {
        if (!data.allowed) {
          throw new Error('Accès non autorisé');
        }
        // Si tout est bon, on peut continuer à afficher le rapport
        console.log("Authentification vérifiée, chargement du rapport...");
      })
      .catch(error => {
        console.error('Erreur de vérification:', error);
        // En cas d'échec, redirection vers la page de connexion
        localStorage.removeItem("isAuthenticated");
        localStorage.removeItem("currentReport");
        localStorage.removeItem("authExpiry");
        document.cookie = "gon_auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        document.cookie = "gon_auth_verified=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        window.location.replace("https://monitoring-g-on.life/");
      });
      
      // Fonction utilitaire pour lire un cookie
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return '';
      }
    })();
  </script>
</head>
<body>
  <noscript>Vous devez activer JavaScript pour exécuter cette application.</noscript>
  <div id="root"></div>
  
  <!-- Script principal (une seule fois) - Utilisez le bon fichier JS pour avril-2025 -->
  <script defer="defer" src="/reports/fourchambault/avril-2025/static/js/main.92138b7e.js"></script>
</body>
</html>